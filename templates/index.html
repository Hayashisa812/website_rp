<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>掲示板サイト</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
</head>
<body>
  <div id="thread"></div>
  <div class="bar"></div>
  <textarea id="input" class="textbox"placeholder="書き込む内容" ></textarea><br>
  <button onclick="submitPost()"class="button">書き込む</button>
  <a class = "back_mainpage" href="/"onclick="del_member()">掲示板一覧に戻る</a>
  <p class="member_text">閲覧中の人</p>
  <div id="member_bar"></div>
  <!--<button class="reaction_button" onclick="submitReaction()">リアクション</button>-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
  <script>


    // Socket.IO クライアントを初期化
    const socket = io();
    const boardName = window.location.pathname.split("/").pop();

    // Function to display messages (変更なし)
    function displayMessages(messages) {
      const thread = document.getElementById("thread");
      thread.innerHTML = ''; // Clear current messages
      // メッセージをそのまま順番に処理
      messages.forEach(post => {
          const postElement = document.createElement("div");
          postElement.className = "post";
          postElement.dataset.messageId = post.id; // 削除のためにIDをカスタムデータ属性として追加
          postElement.dataset.sender = post.sender; // 削除のためにsenderをカスタムデータ属性として追加
          const reactionsContainerId = `reactions-for-${post.id}`;
          if (post.sender === localStorage.getItem("visitorID")) {
            postElement.style.backgroundColor = "white"; // 自分の投稿は白色背景
            postElement.innerHTML =  `<div class = "time">${post.time}</div><span class="id">${post.sender}</span> <button class="delete_button"onclick="delete_post(${post.id})">削除</button><button class="reactions-container" id="${reactionsContainerId}" onclick="submitReaction(${post.id})">反応</button><span>${post.text}</span>`;
            ;
          } else {
            postElement.style.backgroundColor = "rgb(240,240,240)"; // 他の人の投稿は灰色背景
            postElement.innerHTML =`<div class = "time">${post.time}</div><span class="id">${post.sender}</span> ><button class="reactions-container" id="${reactionsContainerId}" onclick="submitReaction(${post.id})">反応</button><span>${post.text}</span`;
             }
          thread.appendChild(postElement); // メッセージを末尾に追加
          //thread.insertBefore(postElement, thread.firstChild);
      });
}


    // Fetch and display messages on page load (変更なし。初回読み込み時に全メッセージを取得)
    window.onload = function() {

      fetch(`/messages/${boardName}`)
        .then(res => res.json())
        .then(data => {
          displayMessages(data);
        });
      add_member();
    };
    function add_member(){
      let visitorID = localStorage.getItem("visitorID");
      if (!visitorID) {
        visitorID = Math.random().toString(36).substring(2, 10);
        localStorage.setItem("visitorID", visitorID);
      }
      socket.on("connect", () => {// 接続が確立された時にメンバー情報を送るようにする
        console.log("✅ Socket.IO connected, now join room:", boardName);
        socket.emit("joinRoom", boardName);

          fetch(`/member/${boardName}`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({sender:visitorID}),
            })
            .then(res => res.json())
            .then(data => {
              // サーバーがWebSocketを通じてメンバー追加イベントをブロードキャストするので、ここでは何もしない
              console.log("メンバー情報を送信しました:", data);
            });
        });
    }
    function del_member(){
      let visitorID = localStorage.getItem("visitorID");
      if (visitorID) {
        fetch(`/del_member/${boardName}`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({sender:visitorID}),
        })
        .then(res => res.json())
        .then(data => {
          // サーバーがWebSocketを通じてメンバー削除イベントをブロードキャストするので、ここでは何もしない
          console.log("メンバー情報を削除しました:", data);
        });
      }
    }
    function submitPost() {
      const inputElement = document.getElementById("input");
      const input = inputElement.value;
      let visitorID =localStorage.getItem("visitorID");
      if (!visitorID) {
      visitorID = Math.random().toString(36).substring(2, 10); // ランダムな8桁IDを生成
      localStorage.setItem("visitorID", visitorID); // 保存
      }
      console.log(visitorID);

      // Clear input field
      inputElement.value = "";

      // Send post to the server (WebSocketを使用するため、メッセージ取得は不要)
      fetch(`/post/${boardName}`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({text: input,sender:visitorID})
      })
      .then(res => res.json())
      .then(data => {
        // サーバーがWebSocketを通じてメッセージをブロードキャストするので、ここでは何もしない
        // displayMessages() を直接呼び出す必要はなくなります
      });
    }
    function delete_post(id){
      fetch(`/delete/${boardName}`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({id:id,sender:localStorage.getItem("visitorID")})
      })
      .then(res => res.json())
      .then(data => {
        // サーバーがWebSocketを通じて削除イベントをブロードキャストするので、ここでは何もしない
      });
    }
    function submitReaction(postID){
      fetch(`/reaction/${boardName}`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({reaction:"https://cdn-icons-png.flaticon.com/512/1077/1077035.png",sender:localStorage.getItem("visitorID"), id:postID}),
  
      })

    }

    // WebSocketイベントリスナー: 新しいメッセージを受信したら表示を更新
    socket.on('new_message', function(msg) {
      const thread = document.getElementById("thread");
      const postElement = document.createElement("div");
      postElement.className = "post";
      postElement.dataset.messageId = msg.id; // 削除のためにIDをカスタムデータ属性として追加
      postElement.dataset.sender = msg.sender; // 削除のためにsenderをカスタムデータ属性として追加
      const reactionsContainerId = `reactions-for-${msg.id}`;
      

      if(msg.sender === localStorage.getItem("visitorID")){
        postElement.style.backgroundColor = "white"; // 自分の投稿は白色背景
        postElement.innerHTML = `<div class = "time">${msg.time}</div><span class="id">${msg.sender}</span> <button class="delete_button"onclick="delete_post(${msg.id})">削除</button><button class="reactions-container" id="${reactionsContainerId}" onclick="submitReaction(${msg.id})">反応</button><span>${msg.text}</span>`;
      }
      else{
        postElement.style.backgroundColor = "rgb(240,240,240)"; // 他の人の投稿は灰色背景
        postElement.innerHTML = `<div class = "time">${msg.time}</div><span class="id">${msg.sender}</span> <button class="reactions-container" id="${reactionsContainerId}" onclick="submitReaction(${msg.id})">反応</button><span>${msg.text}</span>`;
      }
      // 新しいメッセージを一番上に追加
      //thread.insertBefore(postElement, thread.firstChild);
      thread.appendChild(postElement); // メッセージを末尾に追加
    });

    // WebSocketイベントリスナー: メッセージ削除を受信したら表示から削除
    socket.on('delete_message', function(data) {
        const thread = document.getElementById("thread");
        const posts = thread.querySelectorAll('.post');
        posts.forEach(postElement => {
            // dataset.messageIdとdataset.senderが文字列として比較されるため、数値型に変換
            if (parseInt(postElement.dataset.messageId) === data.id && postElement.dataset.sender === data.sender) {
                postElement.remove();
            }
        });
    });
    socket.on('reaction',function(data){
      const thread = document.getElementById(`reactions-for-${data.id}`);
      const postElement_div = document.createElement("div");
      const postElement = document.createElement("img");
      postElement.src = data.reaction; // 'date.reaction' から 'data.reaction' に修正
      postElement.alt = "Reaction";
      postElement.className = "heart"; // style.css で定義されたアニメーションクラス
      postElement.style.width = "30px";
      postElement.style.height = "30px";
      thread.appendChild(postElement);
      postElement.addEventListener('animationend', () => {
        // アニメーションが終了したら、親の div (postElement) を削除
        postElement.remove();
        console.log("リアクション要素を削除しました。"); // 確認用ログ
      });
    })

    socket.on('member',function(date){
    
      console.log("メンバーが追加されました:");
      const thread = document.getElementById("member_bar");
    
      thread.innerHTML = '';

      date[boardName].forEach(memberId => {
        const postElement = document.createElement("div");
        postElement.className = "member"; // スタイルを適用するためのクラス
        postElement.textContent = memberId; // テキストとしてIDを設定
        thread.appendChild(postElement);
      });
      
    });


  </script>
</body>
</html>